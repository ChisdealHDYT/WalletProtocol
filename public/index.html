<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SCC Web3 wallet</title>

  <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/carousel/">

  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href="fontawesome/css/fontawesome.min.css" rel="stylesheet">
  <link href="fontawesome/css/all.min.css" rel="stylesheet">

  <!--- IMPORTANT: CHAIN PARAMS BELOW, DO NOT EDIT UNLESS YOU'RE ABSOLUTELY CERTAIN YOU KNOW WHAT YOU'RE DOING  --->
  <script>
    // In most BTC-derived coins, the below parameters can be found in the 'src/chainparams.cpp' Mainnet configuration.
    // These below params share the same names as the CPP params, so finding and editing these is easy-peasy!

    /* chainparams */
    const PUBKEY_ADDRESS = 125;
    const SCRIPT_ADDRESS = 117;
    const SECRET_KEY     = 253;
  </script>
  
  <!-- Functional Libraries (Cryptography, Hashing, Encryption, Encoding, etc) -->
  <script type="text/javascript" src="../scripts/libs/aes-gcm.js"></script>
  <script type="text/javascript" src="../scripts/libs/crypto-min.js"></script>
  <script type="text/javascript" src="../scripts/libs/crypto-sha256.js"></script>
  <script type="text/javascript" src="../scripts/libs/crypto-sha256-hmac.js"></script>
  <script type="text/javascript" src="../scripts/libs/ripemd160.js"></script>
  <script type="text/javascript" src="../scripts/libs/jsbn.js"></script>
  <script type="text/javascript" src="../scripts/libs/ellipticcurve.js"></script>
  <script type="text/javascript" src="../scripts/libs/script.js"></script>
  <script type="text/javascript" src="../scripts/libs/qrcode.js"></script>
  <script type="text/javascript" src="../scripts/libs/sha256.js"></script>

  <!-- Core Libraries (Script OPCodes, etc) -->
  <script type="text/javascript" src="../scripts/libs/core-lib/script.js"></script>

  <!-- Interface Framework Libraries (GUI, wallet management, networking, etc) -->
  <script type="text/javascript" src="../scripts/settings.js"></script>
  <script type="text/javascript" src="../scripts/wallet.js"></script>
  <script type="text/javascript" src="../scripts/network.js"></script>
  <script type="text/javascript" src="../scripts/bitTrx.js"></script>
  <script type="text/javascript" src="js/switchPages.js"></script>

  <!-- SCP LIBRARY GOES BELOW -->
  <script src="../lib/index.js"></script>
  <!-- SCP LIBRARY GOES ABOVE -->
</head>

<body>
  <div id="loginPage" style="width: 100%; height: 100%; background: linear-gradient(90deg, #0d84f4, #0a43b5 100%); display: none;">
    <div class="container marketing">
      <div class="verticalalign" style="padding-top: 5%;">
        <div class="vertical-center color-white">
          <center>
            <img src="logo.svg" style="height:50px;"><br><br>
          </center>
            <div class="row">
              <div class="col-2"></div>
              <div class="col-8">
                <div class="card card-prop2 mb-4">
                  <div class="card-body font-gray">
                    <div style="padding:30px; color:#5a5a5a" id="createWallet">
                      <center><h5 class="mb-3">Unlock your wallet</h5></center>

                      <label class="form-label" style="font-size:14px;">Password</label>
                      <input id="pass1" type="password" class="form-control mb-2">

                      <table class="mb-4" border="0">
                        <tr style="color:#2973cf; font-size:14px;">
                          <td>
                            <i class="fas fa-info-circle" style="margin-right: 10px;"></i>
                          </td>
                          <td>
                            Please remember to write down your password, if you lose it, StakeCube cannot recover your funds!
                          </td>
                        </tr>
                      </table>

                      <center>
                        <p id="unlockError" style="opacity: 0.8; color: red"></p>
                        <button class="btn btn-success btn-layout" onclick="finishLogin();">Unlock</button>
                      </center>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-2"></div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <Script>
    function finishLogin() {
      let nPass = document.getElementById("pass1").value;
      let nLoginError = document.getElementById("unlockError");
      decryptWallet(nPass).then(done => {
        if (done) {
          nLoginError.innerText = "";
          switchToDashboard();
          console.log("Login successful!");
        } else {
          nLoginError.innerText = "Incorrect Password!";
        }
      });
    }
  </Script>

  <header id="guiHeader">
    <nav class="navbar navbar-expand-md navbar-dark fixed-top navbar-color font-weight-bold">
      <div class="container-fluid">
        <a class="navbar-brand" href="#"><img src="logo.svg" height="30"></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
          aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav me-auto mb-2 mb-md-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#" onclick="switchToDashboard()"><i
                  class="fas fa-tachometer-alt"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="switchToSend()"><i class="fas fa-paper-plane"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="switchToReceive()"><i class="fas fa-money-check"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="switchToAuth()"><i class="fas fa-fingerprint"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <script>
    // GUI module imports
    let authenticator = require("otplib").authenticator;

    // WALLET STATE DATA
    let cachedUTXOs = [];
    let cachedBlockCount = 0;

    // Privkey storage
    let privkeyDecrypted = null;
    let privkeyEncrypted = null;
    let pubkeyMain = null;

    // Statistical / Informational data
    let valueUSD = 0;
    let currentSupply = 0;

    // Cached DOM elements
    let domHeader;
    let domLoginPage;
    let domDashboardPage;
    let domSendPage;
    let domReceivePage;
    let domAuthPage;

    let domReceiveAddress;
    let domBalance;
    let domBalanceUSD;

    let domMarketcap;
    let domPrice;

    let domAuthDisplay;
    let domAuthImport;
    let domAuthTitle;
    let domAuthCode;
    let domAuthTime;

    function getBalance(updateGUI = false) {
      let nBalance = 0;
      for (const nUTXO of cachedUTXOs) {
        // Calculate the balance from our UTXO cache
        nBalance += Number((nUTXO.satoshis / 100000000).toFixed(8));
      }

      // Update the GUI too, if chosen
      if (updateGUI) {
        // Set the balance, and adjust font-size for large balance strings
        domBalance.innerHTML = nBalance;
        domBalance.style.fontSize = nBalance.toString().length > 8 ? "large" : "x-large";
        if (valueUSD > 0)
          domBalanceUSD.innerText = (nBalance * valueUSD).toFixed(2);
        // And update the Receive page pubkey
        domReceiveAddress.innerText = pubkeyMain;
      }

      return Number(nBalance.toFixed(8));
    }

    function sendTransactionGUI() {
      let coinSelection = document.getElementById("sendingCoin");
      console.log(coinSelection);
    }

    function import2FA() {
      let strNewSecret = document.getElementById("authSecretImport").value;
      let testToken = authenticator.generate(strNewSecret);
      if (testToken && testToken.toString().length === 6) {
        localStorage.setItem("authsecret", strNewSecret);
      }
    }

    let lastAuthCode = null;
    function refreshAuthenticator() {
      let strSecret = localStorage.getItem("authsecret");
      if (!strSecret) {
        // No authentication linked
        domAuthImport.style.display = "";
        domAuthDisplay.style.display = "none";
        domAuthTitle.innerText = "Setup your 2FA";
      } else {
        // Auth code already imported
        domAuthImport.style.display = "none";
        domAuthDisplay.style.display = "";
        domAuthTitle.innerText = "Login using 2FA";
        // Fetch the current code
        let authCode = authenticator.generate(strSecret);
        if (lastAuthCode !== authCode)
          domAuthCode.innerText = authCode;
        let authTimeRemaining = authenticator.timeRemaining()
        domAuthTime.innerText = authTimeRemaining + " second" + (authTimeRemaining === 1 ? "" : "s") + " remaining until next code";
        lastAuthCode = authCode;
      }
    }

    setInterval(() => {
      // Check block count + UTXO sync every 10 seconds
      getBlockCount();
      // Update Dashboard stats
      if (valueUSD > 0) {
        domBalanceUSD.innerText = (getBalance() * valueUSD).toFixed(2);
        domPrice.innerText = "$" + valueUSD.toFixed(2);
        if (currentSupply > 0)
          domMarketcap.innerText = "$" + (currentSupply * valueUSD).toLocaleString('en-GB', { maximumFractionDigits: 0});
      }
      // Fetch price and supply info
      getCoinValue();
      getCoinSupply();
    }, 10000);

    // Refresh 2FA system
    setInterval(refreshAuthenticator, 1000);

    onload = () => {
      // Cache all our UI elements
      domHeader = document.getElementById("guiHeader");
      domLoginPage = document.getElementById("loginPage");
      domDashboardPage = document.getElementById('dashboardPage');
      domSendPage = document.getElementById('sendPage');
      domReceivePage = document.getElementById('receivePage');
      domAuthPage = document.getElementById('authPage');
      domAuthDisplay = document.getElementById('authDisplay');
      domAuthImport = document.getElementById('authImport');
      domAuthTitle = document.getElementById('authTitle');
      domReceiveAddress = document.getElementById("receiveAddress");
      domAuthCode = document.getElementById("authCode");
      domAuthTime = document.getElementById("authTime");
      domBalance = document.getElementById("guiBalance");
      domBalanceUSD = document.getElementById("balanceUSD");
      domPrice = document.getElementById("dashboardPrice");
      domMarketcap = document.getElementById("dashboardMarketcap");
      // Now, we initiate the SCP backend!
      init();
      // Check for an encrypted wallet, if one exists, pull up the login screen!
      let encwif = localStorage.getItem("encwif");
      if (encwif && encwif.length > 1) {
        console.log("Encrypted key found: " + encwif);
        privkeyEncrypted = encwif;
        switchToLogin();
      } else {
        // No privkey available, derive a new one and encrypt using the temppass
        let tmppass = localStorage.getItem("tmppass");
        if (!tmppass) throw "Unable to find encwif, and no tmppass available, bailing out!";
        console.log("Unable to find encrypted keys, but tmppass is available, deriving new key...");
        generateWallet().then(objWallet => {
          // Save decrypted copy in memory
          privkeyDecrypted = objWallet.privkey;
          // Encrypt wallet and save it to disk
          encryptWallet(tmppass).then(newEncwif => {
            console.log("Encrypted wallet!");
            console.log(newEncwif);
            console.log(tmppass);
            privkeyEncrypted = newEncwif;
            localStorage.setItem("encwif", privkeyEncrypted);
            // Erase the tmppass from disk and memory
            tmppass = null;
            localStorage.removeItem("tmppass");
            // Load the Dashboard screen
            switchToDashboard();
          });
        });
      }
    }
  </script>

  <main>
    <div class="container marketing pt-navbar" id="dashboardPage">

      <h4 class="mb-5 theme-color-secondary font-weight-bold">Dashboard</h4>

      <div class="row">
        <div class="col-7">

          <div class="card card-prop mb-4">
            <div class="card-body">
              <div class="card-title font-gray font-weight-bold">Balance<span
                  class="float-end theme-color refresh-button"><i class="fas fa-redo-alt"></i></span></div>
              <div class="mt-4 theme-color-secondary font-weight-bold">
                <div class="float-end"><span id="guiBalance" class="font-balance">0</span> <span
                    class="font-size-ticker">SCC</span></div><br><br>
                <div class="float-end balance-usd-props"><span
                    id="balanceUSD" class="font-balance-usd font-gray font-weight-normal">...</span> <span
                    class="font-size-ticker-usd font-gray font-weight-normal">USD</span></div>
              </div>
            </div>
          </div>

          <div class="card card-prop mb-4">
            <div class="card-body">
              <div class="card-title font-gray font-weight-bold">Activity</div>

              <div class="mt-4">
                <div class="float-start text-center">JAN<br>14</div>
                <span class="float-end plus-balance-color font-weight-bold" style="position:relative; top:11px;">
                  +420.00 SCC
                </span>
              </div><br><br>
              <hr style="margin-top:5px; margin-bottom:5px;" class="font-gray">

              <div>
                <div class="float-start text-center">JAN<br>14</div>
                <span class="float-end plus-balance-color font-weight-bold" style="position:relative; top:11px;">
                  +420.00 SCC
                </span>
              </div><br><br>
              <hr style="margin-top:5px; margin-bottom:5px;" class="font-gray">

              <div>
                <div class="float-start text-center">JAN<br>14</div>
                <span class="float-end plus-balance-color font-weight-bold" style="position:relative; top:11px;">
                  +420.00 SCC
                </span>
              </div>
            </div>
          </div>

        </div>
        <div class="col-5">

          <div class="card card-prop mb-4">
            <div class="card-body">
              <div class="card-title font-gray font-weight-bold">Overview</div>
              <div class="mt-4 theme-color-secondary font-weight-bold font-size-overview">
                <span class="font-gray">Price:</span>
                <span class="float-end" id="dashboardPrice">Loading...</span><br>
                <span class="font-gray">Marketcap:</span>
                <span class="float-end" id="dashboardMarketcap">Loading...</span>
              </div>
            </div>
          </div>

          <div class="card card-prop mb-4">
            <div class="card-body">
              <div class="card-title font-gray font-weight-bold" style="margin-bottom:30px;">Tokens</div>

              <div class="mt-3 mb-3 font-gray-2 font-weight-bold" style="font-size:15px;">
                <img src="circular-logo.png" style="width:32px; height:32px;">
                <span style="margin-left:10px;">StakeCubeCoin (SCC)</span>
                <span class="float-end">0 SCC</span>
              </div>

              <div class="mt-3 mb-3 font-gray-2 font-weight-bold" style="font-size:15px;">
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/BTC_Logo.svg/2000px-BTC_Logo.svg.png"
                  style="width:32px; height:32px;">
                <span style="margin-left:10px;">Bitcoin (BTC)</span>
                <span class="float-end">0 BTC</span>
              </div>
            </div>
          </div>

        </div>
      </div>


    </div>

    <div class="container marketing pt-navbar" id="sendPage">
      <h4 class="mb-5 theme-color-secondary font-weight-bold">Send</h4>

      <div class="row">
        <div class="col-2"></div>
        <div class="col-8">

          <div class="card card-prop mb-4">
            <div class="card-body">
              <div class="card-title font-gray font-weight-bold">Withdraw</div>

              <div class="alert alert-danger" style="font-size:13px;"><i class="fas fa-exclamation-triangle"></i> &nbsp;Please make sure to enter the correct address. Transactions cannot be reversed.</div><br>

              <div class="row">
                <div class="col-6">
                  <label class="form-label" style="margin-bottom:0px">Coin/Token:</label>
                  <select id="sendingCoin" class="vodiapicker">
                    <option value="scc" class="test" data-thumbnail="circular-logo.png">StakeCubeCoin (SCC)</option>
                    <option value="btc" data-thumbnail="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/BTC_Logo.svg/2000px-BTC_Logo.svg.png">Bitcoin (BTC)</option>
                  </select>
                  <div class="lang-select input-shadow">
                    <button class="btn-select" value=""></button>
                    <div class="b">
                      <ul id="a"></ul>
                    </div>
                  </div>
                </div>
              </div><br>

              <div class="row">
                <div class="col-6">
                  <label class="form-label" style="margin-bottom:0px">Amount:</label>
                  <input type="text" class="form-control input-shadow"><br>
                </div>
                
                <div class="col-6">
                  <label class="form-label" style="margin-bottom:0px">SCC Address:</label>
                  <input type="text" class="form-control input-shadow"><br>
                </div>

                <div class="col">
                  <center><button class="btn btn-success btn-layout" onclick="sendTransactionGUI()">Send Transaction</button><br></center>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="col-2"></div>
      </div>

    </div>

    <div class="container marketing pt-navbar" id="receivePage">
      <h4 class="mb-5 theme-color-secondary font-weight-bold">Receive</h4>

      <div class="row">
        <div class="col-2"></div>
        <div class="col-8">

          <div class="card card-prop mb-4">
            <div class="card-body">
              <div class="card-title font-gray font-weight-bold">Deposit address</div><br>

              <center><span id="receiveAddress" class="font-weight-bold"></span><span
                  style="padding-left:6px;"><i class="far fa-copy refresh-button"></i></span><br><br></center>
              <div class="alert alert-danger" style="font-size:13px;"><i class="fas fa-exclamation-triangle"></i> Please
                make sure to only send SCC or StakeCubeProtocol tokens to this address. Other coins will be lost and cannot be
                reversed.</div>
              <center><img src="qr.png"></center>
            </div>
          </div>

        </div>
        <div class="col-2"></div>
      </div>

    </div>

    <div class="container marketing pt-navbar" id="authPage">
      <h4 class="mb-5 theme-color-secondary font-weight-bold">StakeCube 2FA</h4>

      <div class="row">
        <div class="col-2"></div>
        <div class="col-8">

          <div class="card card-prop mb-4">
            <div class="card-body">
              <div id="authTitle" class="card-title font-gray font-weight-bold">Setup your 2FA</div><br>
                <div id="authImport">
                  <label class="form-label" style="margin-bottom:0px;">Your 2FA Secret import code</label>
                  <input id="authSecretImport" type="text" placeholder="Your secret code..." class="form-control input-shadow">
                  <center><button onclick="import2FA()" style="margin-top: 10px;" class="btn btn-success btn-layout">Import</button></center>
                  <br>
                </div>
                <center id="authDisplay">
                  <h3 id="authCode" class="font-weight-bold"></h3>
                  <p id="authTime" style="opacity: 0.8;">10 seconds left til next code</p>
                  <br>
                </center>
              <div class="alert alert-danger" style="font-size:13px;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>Do <b>not</b> share these codes with <b>anyone!</b>
              </div>
            </div>
          </div>

        </div>
        <div class="col-2"></div>
      </div>

    </div>
  </main>

  <script src="js/bootstrap.bundle.min.js"></script>
  <script>window.$ = window.jQuery = require('jquery');</script>
  <script src="js/select.js"></script>

</body>

</html>